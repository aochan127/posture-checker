<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Kendall Posture Checker</title>
  <style>
    :root{ --panel-w: 340px; }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family: system-ui, -apple-system, "Segoe UI",
      "Noto Sans JP", Roboto, "Helvetica Neue", Arial, sans-serif;
      color:#0f172a; background:#f8fafc;
    }
    header{
      padding:10px 14px; background:#0ea5e9; color:#fff;
      position:sticky; top:0; z-index:10;
    }
    header h1{ font-size:18px; margin:0; }
    main{ display:flex; gap:14px; padding:14px; }
    #left, #right{ background:#fff; border:1px solid #e5e7eb; border-radius:10px; }
    #left{ flex:1; min-width:0; padding:10px; display:flex; flex-direction:column; gap:8px; }
    #right{ width:var(--panel-w); padding:12px; }
    .row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .row > * { flex:0 0 auto; }
    .grow{ flex:1; }
    label{ font-size:13px; color:#334155; }
    input[type="number"], input[type="text"], select, button{
      font-size:14px; padding:6px 8px; border:1px solid #cbd5e1; border-radius:8px; background:#fff;
    }
    button{ cursor:pointer; }
    button.primary{ background:#0ea5e9; color:#fff; border-color:#0284c7; }
    button.ghost{ background:#f1f5f9; }
    #canvasWrap{ position:relative; border:1px dashed #cbd5e1; border-radius:10px; overflow:hidden; background:#fff; }
    canvas{ display:block; width:100%; height:calc(100dvh - 210px); max-height:900px; background:#000; }
    .section{ border-top:1px solid #e5e7eb; margin-top:10px; padding-top:10px; }
    .badges span{
      display:inline-block; background:#eef2ff; color:#3730a3; font-size:12px;
      padding:2px 8px; border-radius:999px; margin-right:6px; margin-bottom:6px;
    }
    #metrics p, #classification p, #classDef{ margin:6px 0; font-size:14px; }
    textarea#log{
      width:100%; height:140px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:12px; border-radius:8px; border:1px solid #e5e7eb; padding:8px; background:#f8fafc;
    }
    .lm-grid{ display:grid; grid-template-columns:repeat(5,1fr); gap:6px; }
    .lm-grid label{ display:flex; gap:6px; align-items:center; justify-content:center; border:1px solid #e5e7eb; border-radius:8px; padding:6px; }
    .legend{ display:flex; gap:8px; flex-wrap:wrap; font-size:12px; }
    .dot{ width:12px; height:12px; border-radius:50%; display:inline-block; vertical-align:middle; margin-right:4px; }
    .c1{ background:#ef4444; } .c2{ background:#f59e0b; } .c3{ background:#eab308; }
    .c4{ background:#3b82f6; } .c5{ background:#10b981; }
    @media (max-width: 980px){
      main{ flex-direction:column; }
      #right{ width:100%; }
      canvas{ height:60dvh; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Kendall Posture Checker（5区分＋AI）</h1>
  </header>

  <main>
    <!-- 左：キャンバス＆操作 -->
    <section id="left">
      <!-- ファイル入力行 -->
      <div class="row">
        <input id="fileInput" type="file" accept="image/*" />
        <button id="aiBtn" class="primary" disabled data-ai-detect>AI自動抽出</button>
        <button id="clearBtn" class="ghost">リセット</button>
        <select id="sideSelect" title="サイド選択">
          <option value="auto" selected>サイド自動</option>
          <option value="left">左側面</option>
          <option value="right">右側面</option>
        </select>
      </div>

      <!-- 回転ボタン（script側でも自動生成されます） -->
      <div class="row">
        <button id="rotateL" class="ghost">⟲ 左90°</button>
        <button id="rotateR" class="ghost">⟳ 右90°</button>
        <span style="font-size:12px;color:#64748b;">※横向き画像は回転で調整</span>
      </div>

      <!-- ランドマーク選択 -->
      <div class="row legend">
        <div><span class="dot c1"></span>①耳</div>
        <div><span class="dot c2"></span>②肩峰</div>
        <div><span class="dot c3"></span>③大転子</div>
        <div><span class="dot c4"></span>④膝</div>
        <div><span class="dot c5"></span>⑤外果</div>
      </div>
      <div class="lm-grid">
        <label><input type="radio" name="lm" value="0" checked>①</label>
        <label><input type="radio" name="lm" value="1">②</label>
        <label><input type="radio" name="lm" value="2">③</label>
        <label><input type="radio" name="lm" value="3">④</label>
        <label><input type="radio" name="lm" value="4">⑤</label>
      </div>

      <!-- プラムライン -->
      <div class="row section">
        <label>鉛直線 x:</label>
        <input id="plumbX" type="number" style="width:90px" value="0" />
        <button id="centerPlumbBtn" class="ghost">中央へ</button>
        <label><input id="togglePlumb" type="checkbox" checked> 表示</label>
      </div>
      <div class="row">
        <label>外果からのオフセット(px):</label>
        <input id="plumbOffset" type="number" style="width:90px" value="10" />
        <button id="plumbAtAnkleBtn" class="ghost">外果基準で線を置く</button>
      </div>

      <!-- キャンバス -->
      <div id="canvasWrap">
        <canvas id="canvas"></canvas>
      </div>

      <!-- Undo/Redo -->
      <div class="row">
        <button id="undoBtn" class="ghost">Undo</button>
        <button id="redoBtn" class="ghost">Redo</button>
      </div>

      <!-- ログ -->
      <div class="section">
        <label>ログ</label>
        <textarea id="log" readonly></textarea>
      </div>
    </section>

    <!-- 右：結果＆しきい値 -->
    <aside id="right">
      <div class="section" style="border-top:none;margin-top:0;padding-top:0;">
        <h3 style="margin:0 0 8px 0; font-size:16px;">判定</h3>
        <div id="classification"></div>
        <div id="classDef" style="font-size:13px;color:#475569;"></div>
      </div>

      <div class="section">
        <h3 style="margin:0 0 8px 0; font-size:16px;">計測</h3>
        <div id="metrics"></div>
      </div>

      <div class="section">
        <h3 style="margin:0 0 8px 0; font-size:16px;">mm換算（任意）</h3>
        <div class="row">
          <label class="grow">身長（cm）→画像身長(px）</label>
          <input id="scaleHeightCm" type="number" placeholder="例: 170" style="width:90px" />
          <input id="scaleBodyPix" type="number" placeholder="例: 1280" style="width:110px" />
        </div>
        <div class="row">
          <label class="grow">物差し：ピクセルとmm</label>
          <input id="scaleRefPx" type="number" placeholder="px" style="width:90px" />
          <input id="scaleRefMm" type="number" placeholder="mm" style="width:90px" />
        </div>
      </div>

      <div class="section">
        <h3 style="margin:0 0 8px 0; font-size:16px;">しきい値（臨床調整）</h3>
        <div style="font-size:12px;color:#64748b;margin-bottom:6px;">※下記は初期値のままでOK。必要なら調整</div>
        <div class="row">
          <label class="grow">Ideal FHA ≤ <span id="vFhaIdeal">12</span>°</label>
          <input id="thrFhaIdeal" type="range" min="4" max="25" step="1" value="12" class="grow">
        </div>
        <div class="row">
          <label class="grow">Kypho-Lordotic FHA &gt; <span id="vFhaFwd">20</span>°</label>
          <input id="thrFhaFwd" type="range" min="10" max="40" step="1" value="20" class="grow">
        </div>
        <div class="row">
          <label class="grow">大転子 中立±<span id="vHipNeutral">10</span> px</label>
          <input id="thrHipNeutral" type="range" min="2" max="30" step="1" value="10" class="grow">
        </div>
        <div class="row">
          <label class="grow">大転子 前方 ≥ <span id="vHipFwd">10</span> px</label>
          <input id="thrHipFwd" type="range" min="4" max="40" step="1" value="10" class="grow">
        </div>
        <div class="row">
          <label class="grow">大転子 後方 ≤ <span id="vHipBwd">-10</span> px</label>
          <input id="thrHipBwd" type="range" min="-40" max="-4" step="1" value="-10" class="grow">
        </div>
        <div class="row">
          <label class="grow">膝 後方 ≤ <span id="vKneeBack">-5</span> px</label>
          <input id="thrKneeBack" type="range" min="-30" max="0" step="1" value="-5" class="grow">
        </div>
        <div class="row">
          <button id="thrReset" class="ghost">既定に戻す</button>
        </div>
        <div class="badges">
          <span>Ideal</span><span>Kypho-lordotic</span><span>Lordotic</span><span>Flat-back</span><span>Sway-back</span>
        </div>
      </div>
    </aside>
  </main>

  <!-- ライブラリ -->
  <script src="vendor/tf.min.js"></script>
  <script src="vendor/pose-detection.min.js"></script>
  <!-- アプリ本体（最新差し替え版。キャッシュ回避に ?v= を更新） -->
<script src="script.js?v=full-20250824b"></script>
</body>
</html>
